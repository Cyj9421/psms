<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.psms.project.attendance.mapper.AttendanceSummaryMapper">
    <resultMap id="summaryResult" type="com.psms.project.attendance.domain.AttendnceSummary">
            <id property="summaryId" column="summary_id"/>
            <result property="workNum" column="work_num"/>
            <result property="fullName" column="full_name"/>
            <result property="deptName" column="dept_name"/>
            <result property="leader" column="leader"/>
            <result property="postName" column="post_name"/>
            <result property="postCode" column="post_code"/>
            <result property="lateNum" column="late_num"/>
            <result property="earlyNum" column="early_num"/>
            <result property="afdNum" column="afd_num"/>
            <result property="overtime" column="overtime"/>
            <result property="rewardsNum" column="rewards_num"/>
            <result property="punishmentNum" column="punishment_num"/>
            <result property="btNum" column="bt_num"/>
            <result property="reportType" column="report_type"/>
    </resultMap>
    <sql id="summaryVo">
        select s.summary_id,s.work_num,s.late_num,s.early_num,s.afd_num,s.overtime,s.rewards_num,s.punishment_num,s.bt_num,s.report_type,
               d.dept_name,d.leader,
               p.post_name,p.post_code,
               n.full_name
        from attendance_summary s
        left join sys_user_number n on s.work_num=n.work_num
        left join sys_dept d on n.dept_id=d.dept_id
        left join sys_post p on n.post_id=p.post_id
    </sql>
    <sql id="summary">
        SELECT count(*) AS late_num,
	    ( SELECT count(*) FROM attendance_early
	    WHERE early_date between #{startDate} and #{endDate} and work_num=#{workNum}) AS early_num,
	    ( SELECT count(*) FROM attendance_info
	    WHERE is_absenteeism=0 and attendance_date between #{startDate} and #{endDate} and work_num=#{workNum}) AS afd_num,
	    ( SELECT count(*) FROM attendance_rp
	    WHERE operation = 0 and rp_status=1 and update_time between #{startDate} and #{endDate} and work_num=#{workNum}) AS rewards_num,
	    ( SELECT count(*) FROM attendance_rp
	    WHERE operation = 1 and rp_status=1 and update_time between #{startDate} and #{endDate} and work_num=#{workNum}) AS punishment_num,
	    ( SELECT count(*) FROM bussiness_trip
	    WHERE trip_status = 3 and update_trip_time between #{startDate} and #{endDate} and work_num=#{workNum}) AS bt_num,
	    ( SELECT sum(over_time) FROM attendance_overtime
	    WHERE clock_date between #{startDate} and #{endDate} and work_num=#{workNum}) AS overtime
    FROM
	    attendance_late
    WHERE
	    late_date between #{startDate} and #{endDate} and work_num=#{workNum}
    </sql>
    <sql id="summaryToDayVo">
        select i.attendance_id,i.work_num,i.is_overtime,i.is_late,i.is_early,i.is_absenteeism,i.start_time,
        i.end_time,i.attendance_date,i.attendance_status,
               d.dept_name,d.leader,
               p.post_name,p.post_code,
               n.full_name
        from attendance_info i
        left join sys_user_number n on i.work_num=n.work_num
        left join sys_dept d on n.dept_id=d.dept_id
        left join sys_post p on n.post_id=p.post_id

    </sql>
    <insert id="addSummary" parameterType="com.psms.project.attendance.domain.AttendnceSummary">
        insert into attendance_summary(work_num,late_num,early_num,afd_num,overtime,rewards_num,punishment_num,bt_num,report_type)
        values (#{workNum},#{lateNum},#{earlyNum},#{afdNum},#{overtime},#{rewardsNum},#{punishmentNum},#{btNum},#{reportType})
    </insert>
    <select id="summaryList" resultMap="summaryResult" parameterType="com.psms.project.attendance.domain.AttendnceSummary">
        <include refid="summaryVo"/>
        <where>
        <if test="fullName != null and fullName != ''">
            AND n.full_name like concat('%', #{fullName}, '%')
        </if>
        <if test="deptName != null and deptName != ''">
            AND d.dept_name like concat('%', #{deptName}, '%')
        </if>
        <if test="workNum != null and workNum != ''">
            AND s.work_num like concat('%', #{workNum}, '%')
        </if>
        <if test="reportType != null and reportType != ''">
            AND s.report_type = #{reportType}
        </if>
        </where>
        group by s.report_type
    </select>
    <select id="summaryInfo" resultMap="summaryResult">
        <include refid="summaryVo"/>
        where s.summary_id=#{summaryId}
    </select>
    <select id="summaryToType" resultMap="summaryResult" parameterType="com.psms.project.attendance.domain.vo.AttendanceReportDateVo">
    <include refid="summary"/>
    </select>
</mapper>