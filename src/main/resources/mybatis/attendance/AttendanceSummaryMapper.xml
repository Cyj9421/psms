<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.psms.project.attendance.mapper.AttendanceSummaryMapper">
    <resultMap id="summaryResult" type="com.psms.project.attendance.domain.AttendanceSummary">
            <id property="summaryId" column="summary_id"/>
            <result property="workNum" column="work_num"/>
            <result property="fullName" column="full_name"/>
            <result property="deptName" column="dept_name"/>
            <result property="leader" column="leader"/>
            <result property="postName" column="post_name"/>
            <result property="postCode" column="post_code"/>
            <result property="lateNum" column="late_num"/>
            <result property="earlyNum" column="early_num"/>
            <result property="afdNum" column="afd_num"/>
            <result property="overtime" column="overtime"/>
            <result property="rewardsNum" column="rewards_num"/>
            <result property="rewards" column="rewards"/>
            <result property="punishments" column="punishments"/>
            <result property="punishmentNum" column="punishment_num"/>
            <result property="btNum" column="bt_num"/>
            <result property="reportType" column="report_type"/>
            <result property="summaryMonth" column="summary_month"/>
            <result property="summaryQuarter" column="summary_quarter"/>
            <result property="summaryYear" column="summary_year"/>
    </resultMap>
    <sql id="summaryVo">
        select s.summary_id,s.work_num,s.late_num,s.early_num,s.afd_num,s.overtime,s.rewards_num,s.rewards,s.punishment_num,s.punishments,s.bt_num,s.report_type,s.summary_month,s.summary_quarter,s.summary_year,
               d.dept_name,d.leader,
               p.post_name,p.post_code,
               n.full_name
        from attendance_summary s
        left join sys_user_number n on s.work_num=n.work_num
        left join sys_dept d on n.dept_id=d.dept_id
        left join sys_post p on n.post_id=p.post_id
    </sql>
    <sql id="summary">
        SELECT count(*) AS late_num,
	    ( SELECT count(*) FROM attendance_early
	    WHERE early_date between #{startDate} and #{endDate} and work_num=#{workNum}) AS early_num,
	    ( SELECT count(*) FROM attendance_info
	    WHERE is_absenteeism=0 and attendance_date between #{startDate} and #{endDate} and work_num=#{workNum}) AS afd_num,
	    ( SELECT count(*) FROM attendance_rp
	    WHERE operation = 0 and rp_status=1 and update_time between #{startDate} and #{endDate} and work_num=#{workNum}) AS rewards_num,
	    ( select sum(cash_amount) from attendance_rp
        where work_num=#{workNum} and operation=1 and rp_way=1 and rp_status=2 and update_time between #{startDate} and #{endDate}) as rewards,
	    ( SELECT count(*) FROM attendance_rp
	    WHERE operation = 1 and rp_status=1 and update_time between #{startDate} and #{endDate} and work_num=#{workNum}) AS punishment_num,
	    ( select sum(cash_amount) from attendance_rp
        where work_num=#{workNum} and operation=2 and rp_way=1 and rp_status=2 and update_time between #{startDate} and #{endDate}) as punishments,
	    ( SELECT count(*) FROM bussiness_trip
	    WHERE trip_status = 3 and update_trip_time between #{startDate} and #{endDate} and work_num=#{workNum}) AS bt_num,
	    ( SELECT sum(over_time) FROM attendance_overtime
	    WHERE clock_date between #{startDate} and #{endDate} and work_num=#{workNum}) AS overtime
    FROM
	    attendance_late
    WHERE
	    late_date between #{startDate} and #{endDate} and work_num=#{workNum}
    </sql>
    <sql id="summaryToDayVo">
        select i.attendance_id,i.work_num,i.is_overtime,i.is_late,i.is_early,i.is_absenteeism,i.start_time,
        i.end_time,i.attendance_date,i.attendance_status,
               d.dept_name,d.leader,
               p.post_name,p.post_code,
               n.full_name
        from attendance_info i
        left join sys_user_number n on i.work_num=n.work_num
        left join sys_dept d on n.dept_id=d.dept_id
        left join sys_post p on n.post_id=p.post_id

    </sql>
    <insert id="addSummary" parameterType="com.psms.project.attendance.domain.AttendanceSummary">
        insert into attendance_summary
        (
        <if test="workNum != null and workNum != ''">work_num,</if>
        <if test="lateNum != null and lateNum !=0">late_num,</if>
        <if test="earlyNum != null and earlyNum !=0">early_num,</if>
        <if test="afdNum != null and afdNum !=0">afd_num,</if>
        <if test="overtime != null and overtime !=0">overtime,</if>
        <if test="rewardsNum != null and rewardsNum !=0">rewards_num,</if>
        <if test="rewards != null and rewards !=0">rewards,</if>
        <if test="punishmentNum != null and punishmentNum !=0">punishment_num,</if>
        <if test="punishments != null and punishments !=0">punishments,</if>
        <if test="btNum != null and btNum !=0">bt_num,</if>
        <if test="reportType != null and reportType !=0">report_type,</if>
        <if test="summaryMonth != null and summaryMonth !=0">summary_month,</if>
        <if test="summaryQuarter != null and summaryQuarter != 0 ">summary_quarter,</if>
        <if test="summaryYear != null and summaryYear != 0 ">summary_year</if>
        )
        values (
        <if test="workNum != null and workNum != ''">#{workNum},</if>
        <if test="lateNum != null and lateNum != 0 ">#{lateNum},</if>
        <if test="earlyNum != null and earlyNum != 0 ">#{earlyNum},</if>
        <if test="afdNum != null and afdNum != 0 ">#{afdNum},</if>
        <if test="overtime != null and overtime != 0 ">#{overtime},</if>
        <if test="rewardsNum != null and rewardsNum != 0 ">#{rewardsNum},</if>
        <if test="rewards != null and rewards != 0 ">#{rewards},</if>
        <if test="punishmentNum != null and punishmentNum != 0 ">#{punishmentNum},</if>
        <if test="punishments != null and punishments != 0 "> #{punishments},</if>
        <if test="btNum != null and btNum != 0 ">#{btNum},</if>
        <if test="reportType != null and reportType != 0 ">#{reportType},</if>
        <if test="summaryMonth != null and summaryMonth != 0 ">#{summaryMonth},</if>
        <if test="summaryQuarter != null and summaryQuarter != 0 ">#{summaryQuarter},</if>
        <if test="summaryYear != null and summaryYear != 0 ">#{summaryYear}</if>

        )
    </insert>
    <delete id="delSummary" parameterType="int">
        delete from attendance_summary where summary_id in
        <foreach collection="array" item="summaryId" open="(" separator="," close=")">
            #{summaryId}
        </foreach>
    </delete>
    <select id="summaryList" resultMap="summaryResult" parameterType="com.psms.project.attendance.domain.AttendanceSummary">
        <include refid="summaryVo"/>
        <where>
        <if test="fullName != null and fullName != ''">
            AND n.full_name like concat('%', #{fullName}, '%')
        </if>
        <if test="deptName != null and deptName != ''">
            AND d.dept_name like concat('%', #{deptName}, '%')
        </if>
        <if test="workNum != null and workNum != ''">
            AND s.work_num like concat('%', #{workNum}, '%')
        </if>
        <if test="reportType != null and reportType != ''">
            AND s.report_type = #{reportType}
        </if>
        <if test="summaryMonth != null and summaryMonth !=0 ">
            AND s.summary_month = #{summaryMonth}
        </if>
        <if test="summaryQuarter != null and summaryQuarter !=0 ">
            AND s.summary_quarter = #{summaryQuarter}
        </if>
        <if test="summaryYear != null and summaryYear !=0 ">
            AND s.summary_year = #{summaryYear}
        </if>
        </where>
    </select>
    <select id="summaryInfo" resultMap="summaryResult">
        <include refid="summaryVo"/>
        where s.summary_id=#{summaryId}
    </select>
    <select id="summaryToType" resultMap="summaryResult" parameterType="com.psms.project.attendance.domain.vo.AttendanceReportDateVo">
    <include refid="summary"/>
    </select>
</mapper>